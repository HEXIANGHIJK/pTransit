<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>地图显示</title>
    <style>
        html,
        body,
        #container {
            width: 100%;
            height: 100%;
        }

    </style>
    <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css"/>
    <!--引入jQuery-->
    <script src="https://code.jquery.com/jquery-2.2.3.js" type="text/javascript"></script>
    <script type="text/javascript"
            src="https://webapi.amap.com/maps?v=1.4.15&key=d5a0350fba816f16ff15e1c9c7b7ecf9&plugin=AMap.ToolBar,AMap.StationSearch,AMap.Marker,AMap.PixelAMap.Autocomplete,AMap.PlaceSearch,AMap.Autocomplete,AMap.PlaceSearch,AMap.Transfer,AMap.Icon,AMap.Geocoder"></script>
    <script type="text/javascript" src="https://webapi.amap.com/demos/js/liteToolbar.js"></script>
</head>
<!--样式-->
<style>
    /*已登录窗口*/
    /*字体*/
    .barText {
        font-family: 微软雅黑, sans-serif;
        font-size: 14px;
    }

    /*分割线*/
    .barLine {
        height: 1px;
        width: auto;
        background-color: #d75c00
    }

    /*按钮*/
    .barBtn {
        text-align: center;
        height: 25px;
        width: auto;
        background-color: #ff6f00;
        border-radius: 2px;
    }

    /*按钮选中*/
    .barBtnOn {
        text-align: center;
        height: 25px;
        width: auto;
        background-color: #ff7813;
        border-radius: 2px;
    }

    /*未登录窗口*/
    /*按钮*/
    .lgBarBtn {
        text-align: center;
        height: 23px;
        width: auto;
        background-color: #c1c1c1;
        border-radius: 2px;
    }

    .lgBarBtnLeft {
        height: 25px;
        width: auto;
        background-color: #f5f5f5;
        border-radius: 2px;
    }

    #tip {
        background-color: #ddf;
        color: #333;
        border: 1px solid silver;
        box-shadow: 3px 4px 3px 0px silver;
        position: absolute;
        top: 10px;
        right: 10px;
        border-radius: 5px;
        overflow: hidden;
        line-height: 20px;
        width: 20%;
        height: 500px;
    }

    #tip input[type="text"] {
        height: 25px;
        width: 100%;
        border: 0;
        padding-left: 5px;
        border-radius: 3px;
        outline: none;
    }

    #amap-sug-result {
        visibility: visible;
        display: block;
        left: 0px;
        top: 38px;
        min-width: 20px;
    }

    #outer-box {
        height: 100%;
        padding-right: 300px;
    }

    #container {
        height: 100%;
        width: 100%;
    }

    #searchBar {
        height: 30px;
        background: #ccc;
    }

    .searchInput {
        width: 100%;
        height: 30px;
        line-height: 30%;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        border: none;
        border-bottom: 1px solid #ccc;
        padding: 0 5px;
    }

    #searchResults {
        overflow: auto;
        height: calc(100% - 30px);
    }

    .amap_lib_placeSearch,
    .amap-ui-poi-picker-sugg-container {
        border: none !important;
    }

    .amap_lib_placeSearch .poibox.highlight {
        background-color: #CAE1FF;
    }

    .poi-more {
        display: none !important;
    }

    #panel1 {
        position: fixed;
        background-color: white;
        max-height: 90%;
        overflow-y: auto;
        top: 10px;
        right: 10px;
        width: 280px;
    }

    #panel1 .amap-call {
        background-color: #009cf9;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
    }

    #panel1 .amap-lib-driving {
        border-bottom-left-radius: 4px;
        border-bottom-right-radius: 4px;
        overflow: hidden;
    }
</style>

<body style="background-color: #f5f5dc33; display: flex;">

<!--地点选择-->
<div class="scrollbar" style="display: flex;
        flex-direction: column;
        height: auto;
        overflow: auto;
        width: 25%;
        z-index: 999;
        background: #fff;">
    <!--用户栏-->
    <div style="width: 100%; height: auto; display: flex; align-items: center; justify-content: flex-start;">
        <div id="userLogoBg" style="height: 100%;width: auto; background-image: linear-gradient(to right,#6a6a6a, #ffffff); display: flex; align-items: center;">
            <img id="userImg" src="img/unLogin.png"
                 style="border-radius: 30px;width:60px;height:60px; margin: 10px 20px"
                 alt=""/>

        </div>
        <!--未登录窗口-->
        <div id="userBarNo" style="height: 100%; min-width: 70%; width: 100%; display: flex;justify-content: space-around; align-items: center;">
            <div id="inLogin" style="height: 30px; width: 100px; background-color: #ff9248; border-radius: 5px; border: #ff6d00 2px solid; color: white; font-size: 16px; font-weight: 500; display: flex; justify-content: center; align-items: center;"
                 onmousemove="this.style.backgroundColor='#ffd9c0'"
                 onmouseout="this.style.backgroundColor='#ff9248'"
                 onclick="document.getElementById('loginBar').style.display='flex';
                          document.getElementById('userBarNo').style.display='none'">
                <span>登录</span>
            </div>

            <div id="inRegister" style="height: 30px; width: 100px; background-color: #ff9248; border-radius: 5px; border: #ff6d00 2px solid; color: white; font-size: 16px; font-weight: 500; display: flex; justify-content: center; align-items: center;"
                 onmousemove="this.style.backgroundColor='#ffd9c0'"
                 onmouseout="this.style.backgroundColor='#ff9248'"
                 onclick="document.getElementById('registerBar').style.display='flex';
                          document.getElementById('userBarNo').style.display='none'">
                <span>注册</span>
            </div>
        </div>
        <!--登录窗口-->
        <div id="loginBar" style="height: 100%; min-width: 70%; width: 100%; display: none;justify-content: center; align-items: center;">

            <form style="display: flex; flex-direction: column; height: 100%;width: 100%; background-color: #ffffffff; border-radius: 5px;">
                <div style="display: flex; height: 50%; justify-content: stretch; position: relative; border-bottom: 1px solid #DDDDDD">
                    <input type="text" name="username" id="username"
                           style="outline-style: none; border: 0; height: 100%; width: 70%; background-color: white;">
                    <div style="text-align: center; height: 100%; width: 50%; border-top: 40px solid #ffce97;border-left: 40px solid transparent; position: absolute; right: 0; display: flex;"
                         onmousemove="this.style.borderTop=' 40px solid #ffdab4'"
                         onmouseout="this.style.borderTop=' 40px solid #ffce97'"
                         id="loginBtn">
                        <a class="barText"
                           style="height: 100%; width: 100%; position: absolute;top: -35px; right: 0; font-size: 18px; font-weight: 400; color: white;">登录</a>
                    </div>
                </div>
                <div style="display: flex; height: 50%; justify-content: stretch; position: relative;">
                    <input type="text" name="username" id="password"
                           style="outline-style: none; border: 0; height: 100%; width: 70%; background-color: white;">
                    <div style="text-align: center; height: 100%; width: 50%; border-bottom: 40px solid #bfbfbf;border-left: 40px solid transparent; position: absolute; right: 0; display: flex;"
                         onmousemove="this.style.borderBottom=' 40px solid #dddddd'"
                         onmouseout="this.style.borderBottom=' 40px solid #bfbfbf'"
                         onclick="document.getElementById('userBarNo').style.display='flex';
                                  document.getElementById('loginBar').style.display='none'">
                        <a class="barText"
                           style="height: 100%; width: 100%; position: absolute;top: 6px; right: 0; font-size: 18px; font-weight: 400; color: white;">返回</a>
                    </div>
                </div>
            </form>

        </div>
        <!--注册窗口-->
        <div id="registerBar" style="height: 100%; min-width: 70%; width: 100%; display: none;justify-content: center; align-items: center;">

            <form style="display: flex; flex-direction: column; height: 100%;width: 100%; background-color: #ffffffff; border-radius: 5px;">
                <div style="display: flex; height: 50%; justify-content: stretch; position: relative; border-bottom: 1px solid #DDDDDD">
                    <input type="text" name="username" id="rUsername"
                           style="outline-style: none; border: 0; height: 100%; width: 70%; background-color: white;">
                    <div style="text-align: center; height: 100%; width: 50%; border-top: 40px solid #ffe897;border-left: 40px solid transparent; position: absolute; right: 0; display: flex;"
                         onmousemove="this.style.borderTop=' 40px solid #ffecc2'"
                         onmouseout="this.style.borderTop=' 40px solid #ffe897'"
                         onclick="register()">
                        <a class="barText"
                           style="height: 100%; width: 100%; position: absolute;top: -35px; right: 0; font-size: 18px; font-weight: 400; color: white;">注册</a>
                    </div>
                </div>
                <div style="display: flex; height: 50%; justify-content: stretch; position: relative;">
                    <input type="text" name="username" id="rPassword"
                           style="outline-style: none; border: 0; height: 100%; width: 70%; background-color: white;">
                    <div style="text-align: center; height: 100%; width: 50%; border-bottom: 40px solid #bfbfbf;border-left: 40px solid transparent; position: absolute; right: 0; display: flex;"
                         onmousemove="this.style.borderBottom=' 40px solid #eeeeee'"
                         onmouseout="this.style.borderBottom=' 40px solid #bfbfbf'"
                         onclick="document.getElementById('userBarNo').style.display='flex';
                                  document.getElementById('loginBar').style.display='none'">
                        <a class="barText"
                           style="height: 100%; width: 100%; position: absolute;top: 6px; right: 0; font-size: 18px; font-weight: 400; color: white;">返回</a>
                    </div>
                </div>
            </form>

        </div>
        <!--已登录窗口-->
        <div id="userBarOk" style="height: 100%; min-width: 70%; width: 100%; display: none;justify-content: center; align-items: center;">
            <div style="display: flex; flex-direction: column; width: 50%; height: 100%; align-items: flex-start; justify-items: center;">
                    <span style="margin-left:20px; margin-top: 5px; text-align: center; height: 50%; width: 150px; right: 0; display: flex; font-size: 20px;">
                        欢迎
                    </span>
                    <span id="loginUsername" style="margin-left:20px; text-align: center; height: 50%; width: 150px; right: 0; display: flex; font-size: 18px;">

                    </span>

            </div>
            <div style="display: flex; flex-direction: column;width: 100%; height: 100%; justify-content: stretch; position: relative;">
                <div style="text-align: center; height: 50%; width: 150px; border-top: 40px solid #ffe897;border-left: 40px solid transparent; position: absolute; right: 0; display: flex;"
                     onmouseover="this.style.borderTop=' 40px solid #ffecc2'"
                     onmouseout="this.style.borderTop=' 40px solid #ffe897'"
                     onclick="searchFavorites()"
                     id="favorites">
                    <a class="barText"
                       style="height: 100%; width: 100%; position: absolute;top: -35px; right: 0; font-size: 18px; font-weight: 400; color: white;">我的收藏</a>
                </div>
                <div style="text-align: center; height: 50%; width: 110px; border-top: 40px solid #bfbfbf;border-left: 40px solid transparent; position: absolute; right: 0; bottom: 0; display: flex;"
                     onmousemove="this.style.borderTop=' 40px solid #eeeeee'"
                     onmouseout="this.style.borderTop=' 40px solid #bfbfbf'"
                     onclick="document.getElementById('userBarNo').style.display='flex';
                                  document.getElementById('loginBar').style.display='none'"
                     id="logout">
                    <a class="barText"
                       style="height: 100%; width: 100%; position: absolute;top: -35px; right: 0; font-size: 18px; font-weight: 400; color: white;">注销</a>
                </div>
            </div>
        </div>
    </div>
    <div style="display: flex;height: auto;width: 100%; background-color: #e7e7e7; padding: 5px 0px; border-bottom: #979797 1px solid; justify-content: center; align-self: center;">
        <div style="overflow: hidden; border: 2px solid #ff6f00; border-radius: 5px; width: 100%;min-height: 85%; max-height: 100%; margin: 5px 20px; display: flex; background-color: #ff6f00;">
            <div style="display: flex;flex-direction: column;justify-content: center; width: 70%">
                <input type="text" placeholder="选择出发地"
                       id="pathStart"
                       style="border-radius: 0px; height: 50%;width: 100%;background-color: #ffffff; border: 0px; border-bottom: 1px solid #ff6f00;"
                       onfocus="this.style.backgroundColor='#ffe1cb'"
                       onfocusout="this.style.backgroundColor='#ffffff'"
                       oninput="searchPlace(this.value)"
                       value="">
                <input type="text" placeholder="选择目的地"
                       id="pathEnd"
                       style="border-radius: 0px; height: 50%;width: 100%;background-color: #ffffff; border: 0px; border-top: 1px solid #ff6f00;"
                       onfocus="this.style.backgroundColor='#ffe1cb'"
                       onfocusout="this.style.backgroundColor='#ffffff'"
                       oninput="searchPlace(this.value)"
                       value="">
            </div>
            <div style="height: 100%; width: 30%; display: flex; align-items: center; background-color: #ff6f00; justify-content: space-between;">
                <div style="height: 100%;width: 30%; display: flex;align-items: center;margin-left: 5px;">

                    <input type="button" value="⇵"
                           id="changeWays"
                           onclick="changeWays()"
                           style="border-radius: 0px;height: auto;width: 100%;border: 0px; background-color: #ff6f00; color: white; font-size: 22px; font-weight: 500;">
                </div>
                <div style="border-right: 2px solid #ff8925; height: 80%; width: 0px;"></div>
                <input type="button" value="搜索"
                       id="searchWays"
                       style="border-radius: 0px;height: auto;width: 70%;border: 0px; background-color: #ff6f00; color: white; font-size: 18px; font-weight: 500;">
            </div>
        </div>
    </div>
    <div id="panel" style="max-height: 427px;width: auto; position: relative;">

    </div>
    <div style="z-index: 10000; width: 25%; top: 157px; position: absolute; display: flex; flex-direction: column;  background-color: aliceblue; justify-content: flex-start;align-items: center;" id="searchPlace">

    </div>
</div>
<script src="//webapi.amap.com/ui/1.1/main.js?v=1.1.1"></script>


<!--地图框-->
<div style="z-index: 500; border-left: 1px solid gray; width: 75%; height: 100%; position: relative;" id="mapBorder">
    <!-- 加载地图JSAPI脚本 -->
    <div id="container"></div>

    <!--收藏按钮-->
    <div id="favoritesBtn" style="height: 35px; width: 35px; position: absolute; right: 2px; bottom: 40px; background-color: white; border: 1px solid #cccccc; border-radius: 4px; display: flex; justify-content: center; align-items: center; font-size: 26px;color: #a3a3a3; font-weight: 500;">
        <span>★</span>
    </div>
</div>

<!--触发自动定位-->
<div class="info" hidden>
    <h4 id='status'></h4>
    <hr>
    <p id='result'></p>
    <hr>
</div>

</body>

<script src="https://code.jquery.com/jquery-2.2.3.js" type="text/javascript"></script>
<script type="text/javascript">
    $('.barBtn').attr('onmousemove', "this.className='barBtnOn'").attr('onmouseout', "this.className='barBtn'");
    //已登录用户
    var username="";

    /*输入地点类型（0出发，1终点）*/
    var pathType = -1;

    $('#pathStart').focus(function () {
        pathType = 0
    });

    $('#pathEnd').focus(function () {
        pathType = 1
    });


    var map = new AMap.Map('container', {
        resizeEnable: true, //是否监控地图容器尺寸变化
        zoom: 11, //初始化地图层级
    });

    var geocoder = new AMap.Geocoder({
        city: "010", //城市设为北京，默认：“全国”
        radius: 1000 //范围，默认：500
    });

    /*var toolbar = new AMap.ToolBar();
    map.addControl(toolbar);
    */

    var marker = null;
    var marker1 = null;
    var origin = "";
    var destination = "";
    var lng = null;
    var lng1 = null;

    //逆编码
    function regeoCode(data) {

        var lnglat  = data;
        if (pathType===0){
            geocoder.getAddress(lnglat, function(status, result) {

                if (status === 'complete'&&result.regeocode) {
                    var address = result.regeocode.formattedAddress;

                    document.getElementById('pathStart').value = address;

                }else{
                    log.error('根据经纬度查询地址失败')
                }
            });
        }
        else if (pathType===1){
            geocoder.getAddress(lnglat, function(status, result) {

                if (status === 'complete'&&result.regeocode) {
                    var address = result.regeocode.formattedAddress;

                    document.getElementById('pathEnd').value = address;
                }else{
                    log.error('根据经纬度查询地址失败')
                }
            });
        };
    }

    //地图点击触发
    map.on('click', function (ev) {

        // 触发事件的对象
        //var target = ev.target;
        // 触发事件类型
        //var type = ev.type;


        if (pathType === 0) {
            regeoCode(ev.lnglat);
            pathType = -1;

            // 触发事件的地理坐标，AMap.LngLat 类型
            var lnglat = ev.lnglat;
            lng = lnglat;
            //alert(lnglat);
            var lnglatArr = lnglat.toString().split(",");

            // 触发事件的像素坐标，AMap.Pixel 类型
            var pixel = ev.pixel;
            //alert(pixel);
            var pixelArr = pixel.toString().split(",");
            //删除点标记
            if (marker) {
                marker.setMap(null);
                marker = null;
            }
            origin = lnglatArr[0] + "," + lnglatArr[1];
            // 实例化点标记
            var icon = new AMap.Icon({
                size: new AMap.Size(40, 50),    // 图标尺寸
                image: 'https://webapi.amap.com/theme/v1.3/markers/b/start.png',  // Icon的图像
                imageOffset: new AMap.Pixel(0, -60),  // 图像相对展示区域的偏移量，适于雪碧图等
                imageSize: new AMap.Size(40, 50)   // 根据所设置的大小拉伸或压缩图片
            });

            // 创建一个 Icon
            var startIcon = new AMap.Icon({
                // 图标尺寸
                size: new AMap.Size(25, 34),
                // 图标的取图地址
                image: '//a.amap.com/jsapi_demos/static/demo-center/icons/dir-marker.png',
                // 图标所用图片大小
                imageSize: new AMap.Size(135, 40),
                // 图标取图偏移量
                imageOffset: new AMap.Pixel(-9, -3)
            });

            // 将 icon 传入 marker
            marker = new AMap.Marker({
                position: [lnglatArr[0], lnglatArr[1]],
                icon: startIcon,
                offset: new AMap.Pixel(-13, -30)
            });
            marker.setMap(map);
        } else if (pathType === 1) {
            regeoCode(ev.lnglat);
            pathType = -1;

            // 触发事件的地理坐标，AMap.LngLat 类型
            var lnglat1 = ev.lnglat;
            lng1 = lnglat1;
            //alert(lnglat);
            var lnglatArr1 = lnglat1.toString().split(",");

            // 触发事件的像素坐标，AMap.Pixel 类型
            var pixel1 = ev.pixel;
            //alert(pixel);
            var pixelArr1 = pixel1.toString().split(",");
            //删除点标记
            if (marker1) {
                marker1.setMap(null);
                marker1 = null;
            }
            destination = lnglatArr1[0] + "," + lnglatArr1[1];


            // 创建一个 icon
            var endIcon = new AMap.Icon({
                size: new AMap.Size(25, 34),
                image: '//a.amap.com/jsapi_demos/static/demo-center/icons/dir-marker.png',
                imageSize: new AMap.Size(135, 40),
                imageOffset: new AMap.Pixel(-95, -3)
            });

            // 将 icon 传入 marker
            // 实例化点标记
            marker1 = new AMap.Marker({
                position: [lnglatArr1[0], lnglatArr1[1]],
                icon: endIcon,
                offset: new AMap.Pixel(-13, -30)
            });
            marker1.setMap(map);
        }




    });

    //定位按钮
    AMap.plugin('AMap.Geolocation', function () {
        var geolocation = new AMap.Geolocation({
            enableHighAccuracy: true,//是否使用高精度定位，默认:true
            timeout: 10000,          //超过10秒后停止定位，默认：5s
            buttonPosition: 'RB',    //定位按钮的停靠位置
            buttonOffset: new AMap.Pixel(2,2),//定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
            zoomToAccuracy: true,   //定位成功后是否自动调整地图视野到定位点

        });

        map.addControl(geolocation,"right-bottom");
        geolocation.getCurrentPosition(function (status, result) {
            if (status === 'complete') {
                onComplete(result)
            } else {
                onError(result)
            }
        });
    });

    //解析定位结果
    function onComplete(data) {
        document.getElementById('status').innerHTML = '定位成功'
        var str = [];
        str.push('定位结果：' + data.position);
        str.push('定位类别：' + data.location_type);
        if (data.accuracy) {
            str.push('精度：' + data.accuracy + ' 米');
        }//如为IP精确定位结果则没有精度信息
        str.push('是否经过偏移：' + (data.isConverted ? '是' : '否'));
        document.getElementById('result').innerHTML = str.join('<br>');
    }

    //解析定位错误信息
    function onError(data) {
        document.getElementById('status').innerHTML = '定位失败'
        document.getElementById('result').innerHTML = '失败原因排查信息:' + data.message;
    }


    let searchPlaceData;
    //地点查询
    function searchPlace(keywords){
        $.ajax({
            type: "GET",
            url: "//restapi.amap.com/v3/assistant/inputtips?key=056d5aa58b7bb9c02c21d4f61305e3bf",
            data: {keywords: keywords,city: "天津"},
            dataType: "json",
            success: function (data) {
                searchPlaceData=data;
                var searches="";
                for (var i=0;i<data.count;i++){
                    searches+="<div style=\"width: 100%; height: 100%; padding: 2px; border-bottom: 1px solid #a3a3a3;display: flex;flex-direction: column;\" onmouseover=\"this.style.backgroundColor='#f0f0f0'\"onmouseout=\"this.style.backgroundColor='#ffffff'\"onclick=\"getThisLoc("+i+")\"><span style=\"font-size: 16px;font-weight: 700;margin-left: 10px\">"+data.tips[i].name+"</span><span style=\"margin-left: 10px;font-size:14px; color: #a3a3a3\">"+data.tips[i].address+"</span></div>"
                }
                $("#searchPlace").html(searches);
            },
            error: function () {
                alert("查找出错")
            }
        })
    }

    //收藏夹显示
    var favApp=0;
    function searchFavorites(){
        if (favApp===0){
            document.getElementById('favorites').style.borderTop = '40px solid #ffc897';
            document.getElementById('favorites').onmouseover = null;
            document.getElementById('favorites').onmouseout = null;
            $('#panel').empty();
            $.ajax({
                type: "GET",
                url: "way/getFavorites",
                data: {username: username},
                dataType: "json",
                success: function (data) {

                    var searches = "";
                    var startAddress = "";
                    var endAddress = "";

                    for (var i = 0; i < data.length; i++) {

                        var path = data[i];

                        lng = new AMap.LngLat(parseFloat(path.start_path_x), parseFloat(path.start_path_y));
                        lng1 = new AMap.LngLat(parseFloat(path.end_path_x), parseFloat(path.end_path_y));

                        searches += "<div style=\"width: 100%; height: 100%; padding: 2px; border-bottom: 1px solid #a3a3a3;display: flex;flex-direction: column;\" onmouseover=\"this.style.backgroundColor='#f0f0f0'\"onmouseout=\"this.style.backgroundColor='#ffffff'\"onclick=\"getThisFav('" + path.start_place + "','" + path.end_place + "')\"><div><span style=\"font-size: 16px;font-weight: 500;margin-left: 10px\">从</span><span style=\"font-size: 16px;font-weight: 500;margin-left: 10px; overflow: hidden;text-overflow: ellipsis;white-space: nowrap; \">" + path.start_place + "</span></div><div><span style=\"font-size: 16px;font-weight: 500;margin-left: 10px\">到</span><span style=\"font-size: 16px;font-weight: 500;margin-left: 10px; overflow: hidden;text-overflow: ellipsis;white-space: nowrap; \">" + path.end_place + "</span></div></div>"
                    }
                    $("#searchPlace").html(searches);
                },
                error: function () {
                    alert("查找出错")
                }
            })
            favApp=1;
        } else if (favApp===1){
            document.getElementById('favorites').onmouseout="this.style.borderTop=' 40px solid #ffe897'";
            document.getElementById('favorites').onmouseover="this.style.borderTop=' 40px solid #ffecc2'";
            document.getElementById('favorites').style.borderTop='40px solid #ffe897';
            $('#searchPlace').empty();
            $('#panel').empty();
            favApp=0;
        }
    }

    //收藏选项选中
    function getThisFav(start,end){
        document.getElementById('favorites').onmouseout="this.style.borderTop=' 40px solid #ffe897'";
        document.getElementById('favorites').onmouseover="this.style.borderTop=' 40px solid #ffecc2'";
        document.getElementById('favorites').style.borderTop='40px solid #ffe897';
        $('#searchPlace').empty();
        document.getElementById('pathStart').value=start;
        document.getElementById('pathEnd').value=end;

        document.getElementById('searchWays').click();
    }

    //搜索结果选中
    function getThisLoc(count){
        $('#panel').empty();
        if (pathType===0){
            pathType=-1;
            document.getElementById('pathStart').value=searchPlaceData.tips[count].name;
            var lnglatArr = searchPlaceData.tips[count].location.toString().split(",");
            $("#searchPlace").html("");
            lng=new AMap.LngLat(parseFloat(lnglatArr[0]),parseFloat(lnglatArr[1]));
            // 创建一个 Icon
            var startIcon = new AMap.Icon({
                // 图标尺寸
                size: new AMap.Size(25, 34),
                // 图标的取图地址
                image: '//a.amap.com/jsapi_demos/static/demo-center/icons/dir-marker.png',
                // 图标所用图片大小
                imageSize: new AMap.Size(135, 40),
                // 图标取图偏移量
                imageOffset: new AMap.Pixel(-9, -3)
            });

            // 将 icon 传入 marker
            marker = new AMap.Marker({
                position: [lnglatArr[0], lnglatArr[1]],
                icon: startIcon,
                offset: new AMap.Pixel(-13, -30)
            });
            marker.setMap(map);
        }else if (pathType===1){
            pathType=-1;
            document.getElementById('pathEnd').value=searchPlaceData.tips[count].name;
            var lnglatArr1 = searchPlaceData.tips[count].location.toString().split(",");
            $("#searchPlace").html("");
            lng1=new AMap.LngLat(parseFloat(lnglatArr1[0]),parseFloat(lnglatArr1[1]));

            // 创建一个 icon
            var endIcon = new AMap.Icon({
                size: new AMap.Size(25, 34),
                image: '//a.amap.com/jsapi_demos/static/demo-center/icons/dir-marker.png',
                imageSize: new AMap.Size(135, 40),
                imageOffset: new AMap.Pixel(-95, -3)
            });

            // 将 icon 传入 marker
            // 实例化点标记
            marker1 = new AMap.Marker({
                position: [lnglatArr1[0], lnglatArr1[1]],
                icon: endIcon,
                offset: new AMap.Pixel(-13, -30)
            });
            marker1.setMap(map);
        }else{

        }

    }

    //收藏
    $('#favoritesBtn').click(function (){
        if (!username){
            alert("请先登录");
            $('#inLogin').click();
        }else if (lng&&lng1){
            var pathStart=lng.getLng()+","+lng.getLat();
            var pathEnd=lng1.getLng()+","+lng1.getLat();
            var startPlace= document.getElementById('pathStart').value;
            var endPlace=document.getElementById('pathEnd').value;


            $.ajax({
                type: "POST",

                url: "way/saveWay",

                data: {username: username, pathStart: pathStart, pathEnd: pathEnd, startPlace: startPlace, endPlace: endPlace},

                dataType: "json",

                success: function (data) {
                    if (data){
                        document.getElementById('favoritesBtn').style.color='#ffbf00';
                    }else{
                        alert("已有收藏");
                        document.getElementById('favoritesBtn').style.color='#ffbf00';
                    }
                },

                error: function () {
                    alert("收藏错误!");
                }


            });
        }

    })

    //注册操作
    function register() {
        var rUsername=$('#rUsername').val();
        var rPassword=$('#rPassword').val();
        if (rUsername && rUsername !== "null" && rUsername !== null && rPassword && rPassword!=="Null" &&rPassword!==null) {

            $.ajax({
                type: "POST",
                url: "user/register",
                data: {username: $('#rUsername').val(), password: $('#rPassword').val()},
                dataType: "json",
                success: function (data) {
                    if (data !== null || data !== "null") {
                        alert("注册成功！");
                        temCheck();
                        //$('#registerBar').attr("hidden","true");
                        document.getElementById('registerBar').hidden = true;
                        //$('#loginBar').attr("hidden","false");
                        document.getElementById('loginBar').hidden = false;
                    } else {
                        alert("该用户已存在！");
                    }
                },
                error: function () {
                    alert("该用户已存在！");
                    document.getElementById('rUsername').innerHTML = "";
                    document.getElementById('rPassword').innerHTML = "";
                }
            })
        }
    }

    //伪登录名验证
    function temCheck() {
        $.ajax({
            type: "GET",

            url: "user/temCheck",

            data: {},

            dataType: "json",

            success: function (data) {
                if (data != null) {
                    //存在伪登陆信息
                    $('#username').attr("value", data.username);
                    $('#password').attr("value", data.password);
                }
            },
            error: function () {


            }


        });
    }


    //触发登陆状态验证
    $(function (){
        checkLogin();
    })

    //登陆状态验证
    function checkLogin() {
        $.ajax({
            type: "POST",

            url: "user/check",

            data: {},

            dataType: "json",

            success: function (data) {
                if (data != null) {
                    username=data.username;
                    //是登陆状态
                    document.getElementById('userBarNo').style.display='none';
                    document.getElementById('userBarOk').style.display='flex';
                    document.getElementById('userLogoBg').style.backgroundImage='linear-gradient(to right,#ff8c00, #ffffff)';
                    $('#userImg').attr('src', data.img);
                    $('#loginUsername').html(data.username).style = "max-width:145px ;font-family:微软雅黑,sans-serif; font-size:20px;overflow: hidden;text-overflow: ellipsis;white-space: nowrap;";
                } else {
                    //不是登陆状态
                    $('#bar').attr('onclick', "if(document.getElementById('loginBar').hidden!=true){document.getElementById('userBarNo').hidden=true;document.getElementById('loginBar').hidden=true;} else{document.getElementById('userBarNo').hidden=!document.getElementById('userBarNo').hidden;}");
                }
            },
            error: function () {
                //检查登陆状态出错
                $('#bar').attr('onclick', "if(document.getElementById('loginBar').hidden!=true){document.getElementById('userBarNo').hidden=true;document.getElementById('loginBar').hidden=true;} else{document.getElementById('userBarNo').hidden=!document.getElementById('userBarNo').hidden;}");
            }


        });
    }

    //交换始终地
    function changeWays(){
        var pathStart=document.getElementById('pathStart').value;
        document.getElementById('pathStart').value=document.getElementById('pathEnd').value;
        document.getElementById('pathEnd').value=pathStart;

        var lng2=lng;
        lng=lng1;
        lng1=lng2;

        if (transfer) {
            transfer.clear();
            $('#panel').empty();
            searchWays();
        }
    }

    //登录
    $('#loginBtn').click(function () {

        $.ajax({
            type: "POST",

            url: "user/login",

            data: {username: $('#username').val(), password: $('#password').val()},

            dataType: "json",

            success: function (data) {
                if (data.username === null) {
                    alert("用户名或密码错误");
                } else {
                    alert("登录成功");
                    checkLogin();
                    document.getElementById('loginBar').style.display='none';
                    document.getElementById('userBarOk').style.display='flex';
                }
            },

            error: function () {
                alert("登录出错！");
            }


        });
    })

    //注销
    $('#logout').click(function () {
        $.post("user/logout");
        window.location = "http://localhost:8080/";
    })


    //搜索路线
    $('#searchWays').click(function (){
        searchWays();
    });
    var transfer;
    function searchWays(){
        document.getElementById('favoritesBtn').style.color='#cccccc';
        $('#panel').empty();

        if (marker) {
            marker.setMap(null);
        }
        if (marker1) {
            marker1.setMap(null);
        }
        if (transfer) {
            transfer.clear();
        }


        //构造路线导航类
        transfer = new AMap.Transfer({
            map: map,
            panel: "panel",
            city: "天津"
        });
        // 根据起终点经纬度规划驾车导航路线
        transfer.search(lng, lng1, function (status, result) {
            // result 即是对应的驾车导航信息，相关数据结构文档请参考  https://lbs.amap.com/api/javascript-api/reference/route-search#m_DrivingResult
            if (status === 'complete') {

            } else {
                alert('获取驾车数据失败：' + result);
            }
        });

        $.ajax({
            type: "POST",

            url: "way/getWay",

            data: {origin: origin, destination: destination},

            dataType: "json",

            success: function (data) {

            },

            error: function () {
                alert("出现错误!");
            }


        });


    }

</script>
</html>